<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Son & Thao Wedding</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #111;
            color: white;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 90%;
            max-width: 900px;
            background: #222;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, .4);
        }

        select {
            padding: 6px 10px;
            border-radius: 6px;
            background: #333;
            color: white;
            border: none;
            margin-left: 4px;
        }

        .slideshow {
            position: relative;
            height: 70vh;
            background: black;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 12px;
        }

        .slide-img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            opacity: 0;
            transform: translateX(100%);
            transition: transform .5s cubic-bezier(0.22, 0.61, 0.36, 1), opacity .5s ease-out;
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            border-radius: 50%;
            padding: 8px 12px;
            font-size: 28px;
            background: rgba(0, 0, 0, .5);
            color: white;
            cursor: pointer;
            z-index: 10;
        }

        .nav-prev {
            left: 10px
        }

        .nav-next {
            right: 10px
        }

        .thumbs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            margin-top: 10px;
        }

        .thumbs img {
            height: 60px;
            border-radius: 6px;
            cursor: pointer;
            opacity: .6;
            transition: .2s;
        }

        .thumbs img.active {
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 0 0 2px white;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>Son & Thao Wedding</h2>

        Album:
        <select id="albumSelect"></select>

        <div class="slideshow">
            <button class="nav-btn nav-prev">&#10094;</button>

            <img id="imgA" class="slide-img" alt="">
            <img id="imgB" class="slide-img" alt="">

            <button class="nav-btn nav-next">&#10095;</button>
        </div>

        <div id="caption" style="margin-top:8px; opacity:.8;"></div>
        <div id="imageCounter" style="margin-top:4px; opacity:.8; font-size:14px;">ac</div>
        <div class="thumbs" id="thumbs"></div>
    </div>

    <script>
        // Số ảnh load mỗi đợt & ngưỡng prefetch
        const BATCH_SIZE = 20;
        const PREFETCH_BEFORE_END = 5; // còn 5 ảnh cuối thì load thêm 20
        let totalAlbumImages = 0;

        // albums = { "Pre wedding": ["SUR_8634.jpg", ...], "Album2": [...] }
        let albums = {};

        const albumSelect = document.getElementById("albumSelect");
        const imgA = document.getElementById("imgA");
        const imgB = document.getElementById("imgB");
        const caption = document.getElementById("caption");
        const thumbs = document.getElementById("thumbs");

        let currentAlbum = "";
        let images = [];              // danh sách ảnh ĐÃ LOAD (tăng dần)
        let currentIndex = 0;         // index trong images

        let isAnimating = false;
        let currentEl = imgA;
        let bufferEl = imgB;

        // ---------------------------
        // Đọc & parse file CSV
        // ---------------------------
        async function loadCsv() {
            try {
                const res = await fetch("albums.csv");
                if (!res.ok) {
                    console.error("Không đọc được albums.csv");
                    caption.textContent = "Không đọc được file albums.csv";
                    return;
                }
                const text = await res.text();
                parseCSV(text);
                buildAlbumDropdown();
            } catch (e) {
                console.error(e);
                caption.textContent = "Lỗi khi load file albums.csv";
            }
        }

        function parseCSV(text) {
            const lines = text.trim().split("\n");
            if (lines.length <= 1) return;

            lines.shift(); // bỏ header "Album,filename"
            albums = {};

            for (let line of lines) {
                if (!line.trim()) continue;
                const parts = line.split(",");
                if (parts.length < 2) continue;

                const album = parts[0].trim();
                const filename = parts[1].trim();

                if (!albums[album]) albums[album] = [];
                albums[album].push(filename);
            }
        }

        // ---------------------------
        // Dropdown album
        // ---------------------------
        function buildAlbumDropdown() {
            albumSelect.innerHTML = "";

            const keys = Object.keys(albums);
            if (keys.length === 0) {
                caption.textContent = "Không có dữ liệu album trong CSV";
                return;
            }

            keys.forEach(name => {
                const op = document.createElement("option");
                op.value = name;
                op.textContent = name;
                albumSelect.appendChild(op);
            });

            currentAlbum = keys[0];
            loadAlbum(currentAlbum);
        }

        albumSelect.addEventListener("change", () => {
            loadAlbum(albumSelect.value);
        });

        // ---------------------------
        // Load album: reset & load batch đầu
        // ---------------------------
        function loadAlbum(name) {
            currentAlbum = name;
            currentIndex = 0;
            images = [];

            const all = albums[currentAlbum] || [];
            totalAlbumImages = all.length;

            thumbs.innerHTML = "";
            initFirstBatch();
            updateCounter();
        }

        function updateCounter() {
            const counterEl = document.getElementById("imageCounter");
            counterEl.textContent = `Ảnh ${currentIndex + 1} / ${totalAlbumImages}`;
        }

        function initFirstBatch() {
            const all = albums[currentAlbum] || [];
            if (all.length === 0) {
                imgA.style.opacity = 0;
                imgB.style.opacity = 0;
                caption.textContent = "Album này không có ảnh";
                return;
            }

            // Lấy 20 ảnh đầu
            const count = Math.min(BATCH_SIZE, all.length);
            images = all.slice(0, count);

            buildThumbsFromScratch();
            initSlide();
        }

        // ---------------------------
        // Thumbnails
        // ---------------------------
        function buildThumbsFromScratch() {
            thumbs.innerHTML = "";
            images.forEach((filename, idx) => {
                const t = document.createElement("img");
                t.src = `images/${currentAlbum}/${filename}`;
                t.alt = filename;
                t.onclick = () => goTo(idx, idx > currentIndex ? "right" : "left");
                thumbs.appendChild(t);
            });
        }

        function appendThumbs(newFiles, startIndex) {
            newFiles.forEach((filename, offset) => {
                const idx = startIndex + offset;
                const t = document.createElement("img");
                t.src = `images/${currentAlbum}/${filename}`;
                t.alt = filename;
                t.onclick = () => goTo(idx, idx > currentIndex ? "right" : "left");
                thumbs.appendChild(t);
            });
        }

        function highlightThumb() {
            thumbs.querySelectorAll("img").forEach((t, i) => {
                t.classList.toggle("active", i === currentIndex);
            });
        }

        // ---------------------------
        // Khởi tạo slide đầu tiên
        // ---------------------------
        function initSlide() {
            if (!images.length) return;

            currentEl = imgA;
            bufferEl = imgB;

            currentEl.style.transition = "none";
            bufferEl.style.transition = "none";

            currentEl.src = `images/${currentAlbum}/${images[0]}`;
            currentEl.style.transform = "translateX(0)";
            currentEl.style.opacity = 1;

            bufferEl.style.transform = "translateX(100%)";
            bufferEl.style.opacity = 0;

            currentIndex = 0;
            caption.textContent = images[0];
            highlightThumb();
            updateCounter();
        }

        // ---------------------------
        // Tự load thêm batch (20 ảnh) khi gần cuối
        // ---------------------------
        function maybeLoadMore() {
            const all = albums[currentAlbum] || [];
            if (images.length >= all.length) return; // đã load hết

            // nếu chưa tới 5 ảnh cuối thì thôi
            if (currentIndex < images.length - PREFETCH_BEFORE_END) return;

            const remaining = all.length - images.length;
            const count = Math.min(BATCH_SIZE, remaining);
            const start = images.length;
            const newFiles = all.slice(start, start + count);

            images = images.concat(newFiles);
            appendThumbs(newFiles, start);
        }

        // ---------------------------
        // Hiệu ứng slide full màn hình
        // ---------------------------
        function goTo(index, direction = "right") {
            if (isAnimating || !images.length) return;

            // Không cho vòng lại: giới hạn trong [0, images.length - 1]
            let nextIndex = index;
            if (nextIndex < 0) nextIndex = 0;
            if (nextIndex >= images.length) nextIndex = images.length - 1;
            if (nextIndex === currentIndex) return;

            isAnimating = true;

            const fromEl = currentEl;
            const toEl = bufferEl;

            const offsetIn = direction === "right" ? 100 : -100;
            const offsetOut = -offsetIn;

            fromEl.style.transition = "none";
            toEl.style.transition = "none";

            toEl.src = `images/${currentAlbum}/${images[nextIndex]}`;

            fromEl.style.transform = "translateX(0%)";
            toEl.style.transform = `translateX(${offsetIn}%)`;
            toEl.style.opacity = 1;

            void toEl.offsetWidth; // force reflow

            const easing = "cubic-bezier(0.22,0.61,0.36,1)";
            const duration = 500;

            fromEl.style.transition = `transform ${duration}ms ${easing}, opacity ${duration}ms`;
            toEl.style.transition = `transform ${duration}ms ${easing}, opacity ${duration}ms`;

            fromEl.style.transform = `translateX(${offsetOut}%)`;
            fromEl.style.opacity = 0.2;

            toEl.style.transform = "translateX(0%)";
            toEl.style.opacity = 1;

            fromEl.addEventListener("transitionend", function done() {
                fromEl.removeEventListener("transitionend", done);

                fromEl.style.transition = "none";
                fromEl.style.opacity = 0;
                fromEl.style.transform = `translateX(${offsetIn}%)`;

                currentIndex = nextIndex;
                caption.textContent = images[currentIndex];
                highlightThumb();
                updateCounter();

                // Đảo role 2 img
                currentEl = toEl;
                bufferEl = fromEl;

                isAnimating = false;

                // Sau khi chuyển xong 1 ảnh, check xem có cần load thêm batch không
                maybeLoadMore();
            });
        }

        // Nút điều hướng
        document.querySelector(".nav-prev").onclick = () => {
            goTo(currentIndex - 1, "left");
        };
        document.querySelector(".nav-next").onclick = () => {
            goTo(currentIndex + 1, "right");
        };

        // ---------------------------
        // Vuốt để chuyển ảnh
        // ---------------------------
        let touchStartX = 0;
        let touchEndX = 0;
        const swipeZone = document.querySelector(".slideshow");

        swipeZone.addEventListener("touchstart", (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });

        swipeZone.addEventListener("touchend", (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            const swipeDistance = touchEndX - touchStartX;
            if (Math.abs(swipeDistance) < 50) return; // bỏ vuốt nhẹ

            if (swipeDistance > 0) {
                // vuốt sang phải -> ảnh trước
                goTo(currentIndex - 1, "left");
            } else {
                // vuốt sang trái -> ảnh sau
                goTo(currentIndex + 1, "right");
            }
        }

        // ---------------------------
        // Bắt đầu: load CSV khi trang sẵn sàng
        // ---------------------------
        document.addEventListener("DOMContentLoaded", () => {
            loadCsv();
        });
    </script>

</body>

</html>