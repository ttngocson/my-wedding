<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Son & Thao Wedding</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #111;
            color: white;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 90%;
            max-width: 900px;
            background: #222;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, .4);
        }

        select {
            padding: 6px 10px;
            border-radius: 6px;
            background: #333;
            color: white;
            border: none;
            margin-left: 4px;
        }

        .slideshow {
            position: relative;
            height: 70vh;
            background: black;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 12px;
        }

        .slide-img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            opacity: 0;
            transform: translateX(100%);
            transition: transform .5s cubic-bezier(0.22, 0.61, 0.36, 1), opacity .5s ease-out;
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            border-radius: 50%;
            padding: 8px 12px;
            font-size: 28px;
            background: rgba(0, 0, 0, .5);
            color: white;
            cursor: pointer;
            z-index: 10;
        }

        .nav-prev {
            left: 10px
        }

        .nav-next {
            right: 10px
        }

        .thumbs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            overflow-y: hidden;
            margin-top: 10px;
        }

        .thumbs img {
            height: 60px;
            border-radius: 6px;
            cursor: pointer;
            opacity: .6;
            transition: .2s;
        }

        .thumbs img.active {
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 0 0 2px white;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>Son & Thao Wedding</h2>

        Album:
        <select id="albumSelect"></select>

        <div class="slideshow">
            <button class="nav-btn nav-prev">&#10094;</button>

            <img id="imgA" class="slide-img" alt="">
            <img id="imgB" class="slide-img" alt="">

            <button class="nav-btn nav-next">&#10095;</button>
        </div>

        <div id="caption" style="margin-top:8px; opacity:.8;"></div>
        <div id="imageCounter" style="margin-top:4px; opacity:.8; font-size:14px;">ac</div>
        <div class="thumbs" id="thumbs"></div>
    </div>

    <script>
        // S·ªë ·∫£nh load m·ªói ƒë·ª£t & ng∆∞·ª°ng prefetch
        const BATCH_SIZE = 20;
        const PREFETCH_BEFORE_END = 5; // c√≤n 5 ·∫£nh cu·ªëi th√¨ load th√™m 20
        let totalAlbumImages = 0;

        // albums = { "Pre wedding": ["SUR_8634.jpg", ...], "Album2": [...] }
        let albums = {};

        const albumSelect = document.getElementById("albumSelect");
        const imgA = document.getElementById("imgA");
        const imgB = document.getElementById("imgB");
        const caption = document.getElementById("caption");
        const thumbs = document.getElementById("thumbs");

        let currentAlbum = "";
        let images = [];              // danh s√°ch ·∫£nh ƒê√É LOAD (tƒÉng d·∫ßn)
        let currentIndex = 0;         // index trong images

        let isAnimating = false;
        let currentEl = imgA;
        let bufferEl = imgB;

        // ---------------------------
        // ƒê·ªçc & parse file CSV
        // ---------------------------
        async function loadCsv() {
            try {
                const res = await fetch("albums.csv");
                if (!res.ok) {
                    console.error("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c albums.csv");
                    caption.textContent = "Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file albums.csv";
                    return;
                }
                const text = await res.text();
                parseCSV(text);
                buildAlbumDropdown();
            } catch (e) {
                console.error(e);
                caption.textContent = "L·ªói khi load file albums.csv";
            }
        }

        function parseCSV(text) {
            const lines = text.trim().split("\n");
            if (lines.length <= 1) return;

            lines.shift(); // b·ªè header "Album,filename"
            albums = {};

            for (let line of lines) {
                if (!line.trim()) continue;
                const parts = line.split(",");
                if (parts.length < 2) continue;

                const album = parts[0].trim();
                const filename = parts[1].trim();

                if (!albums[album]) albums[album] = [];
                albums[album].push(filename);
            }
        }

        // ---------------------------
        // Dropdown album
        // ---------------------------
        function buildAlbumDropdown() {
            albumSelect.innerHTML = "";

            const keys = Object.keys(albums);
            if (keys.length === 0) {
                caption.textContent = "Kh√¥ng c√≥ d·ªØ li·ªáu album trong CSV";
                return;
            }

            keys.forEach(name => {
                const op = document.createElement("option");
                op.value = name;
                op.textContent = name;
                albumSelect.appendChild(op);
            });

            currentAlbum = keys[0];
            loadAlbum(currentAlbum);
        }

        albumSelect.addEventListener("change", () => {
            loadAlbum(albumSelect.value);
        });

        // ---------------------------
        // Load album: reset & load batch ƒë·∫ßu
        // ---------------------------
        function loadAlbum(name) {
            currentAlbum = name;
            currentIndex = 0;
            images = [];

            const all = albums[currentAlbum] || [];
            totalAlbumImages = all.length;

            thumbs.innerHTML = "";
            initFirstBatch();
            updateCounter();
        }

        function updateCounter() {
            const counterEl = document.getElementById("imageCounter");
            counterEl.textContent = `·∫¢nh ${currentIndex + 1} / ${totalAlbumImages}`;
        }

        function initFirstBatch() {
            const all = albums[currentAlbum] || [];
            if (all.length === 0) {
                imgA.style.opacity = 0;
                imgB.style.opacity = 0;
                caption.textContent = "Album n√†y kh√¥ng c√≥ ·∫£nh";
                return;
            }

            // L·∫•y 20 ·∫£nh ƒë·∫ßu
            const count = Math.min(BATCH_SIZE, all.length);
            images = all.slice(0, count);

            buildThumbsFromScratch();
            initSlide();
        }

        // ---------------------------
        // Thumbnails
        // ---------------------------
        function buildThumbsFromScratch() {
            thumbs.innerHTML = "";
            images.forEach((filename, idx) => {
                const t = document.createElement("img");
                t.src = `images/${currentAlbum}/${filename}`;
                t.alt = filename;
                t.onclick = () => goTo(idx, idx > currentIndex ? "right" : "left");
                thumbs.appendChild(t);
            });
        }

        function appendThumbs(newFiles, startIndex) {
            newFiles.forEach((filename, offset) => {
                const idx = startIndex + offset;
                const t = document.createElement("img");
                t.src = `images/${currentAlbum}/${filename}`;
                t.alt = filename;
                t.onclick = () => goTo(idx, idx > currentIndex ? "right" : "left");
                thumbs.appendChild(t);
            });
        }

        function highlightThumb(activeIndex = currentIndex) {
            thumbs.querySelectorAll("img").forEach((t, i) => {
                t.classList.toggle("active", i === activeIndex);
            });
        }


        function scrollThumbIntoView(index) {
            const thumbItems = thumbs.querySelectorAll("img");
            const item = thumbItems[index];
            if (!item) return;

            const container = thumbs;

            const itemLeft = item.offsetLeft;
            const itemWidth = item.offsetWidth;
            const containerWidth = container.clientWidth;

            // Scroll ƒë·ªÉ thumbnail n·∫±m gi·ªØa thanh cu·ªôn
            const scrollTo = itemLeft - (containerWidth / 2) + (itemWidth / 2);

            container.scrollTo({
                left: scrollTo,
                behavior: "smooth"
            });
        }


        // ---------------------------
        // Kh·ªüi t·∫°o slide ƒë·∫ßu ti√™n
        // ---------------------------
        function initSlide() {
            if (!images.length) return;

            currentEl = imgA;
            bufferEl = imgB;

            currentEl.style.transition = "none";
            bufferEl.style.transition = "none";

            currentEl.src = `images/${currentAlbum}/${images[0]}`;
            currentEl.style.transform = "translateX(0)";
            currentEl.style.opacity = 1;

            bufferEl.style.transform = "translateX(100%)";
            bufferEl.style.opacity = 0;

            currentIndex = 0;
            caption.textContent = images[0];
            highlightThumb();
            scrollThumbIntoView(currentIndex);
            updateCounter();
        }

        // ---------------------------
        // T·ª± load th√™m batch (20 ·∫£nh) khi g·∫ßn cu·ªëi
        // ---------------------------
        let isLoadingMore = false;
        function maybeLoadMore() {
            const all = albums[currentAlbum] || [];
            if (images.length >= all.length) return; // ƒë√£ load h·∫øt
            if (isLoadingMore) return;               // ƒëang load, kh√¥ng load ti·∫øp

            // Ch·ªâ load khi c√≤n <= PREFETCH_BEFORE_END ·∫£nh
            const needPrefetch =
                currentIndex >= images.length - PREFETCH_BEFORE_END;

            // Ho·∫∑c ng∆∞·ªùi d√πng scroll ƒë·∫øn cu·ªëi thumbnails
            const scrolledToEnd =
                thumbs.scrollLeft >= thumbs.scrollWidth - thumbs.clientWidth - 50;

            if (!needPrefetch && !scrolledToEnd) return;

            isLoadingMore = true;

            // Load th√™m batch 20
            const remaining = all.length - images.length;
            const count = Math.min(BATCH_SIZE, remaining);

            const start = images.length;
            const newFiles = all.slice(start, start + count);

            images = images.concat(newFiles);

            // G·∫Øn thumbnail m·ªõi
            appendThumbs(newFiles, start);

            isLoadingMore = false;
        }


        // ---------------------------
        // Hi·ªáu ·ª©ng slide full m√†n h√¨nh
        // ---------------------------
        function goTo(index, direction = "right") {
            if (isAnimating || !images.length) return;

            // Kh√¥ng cho v√≤ng l·∫°i: gi·ªõi h·∫°n trong [0, images.length - 1]
            let nextIndex = index;
            if (nextIndex < 0) nextIndex = 0;
            if (nextIndex >= images.length) nextIndex = images.length - 1;
            if (nextIndex === currentIndex) return;

            isAnimating = true;

            const fromEl = currentEl;
            const toEl = bufferEl;

            // üîπ ƒê·ªïi highlight & scroll thumbnail NGAY khi animation b·∫Øt ƒë·∫ßu
            highlightThumb(nextIndex);
            scrollThumbIntoView(nextIndex);


            const offsetIn = direction === "right" ? 100 : -100;
            const offsetOut = -offsetIn;

            fromEl.style.transition = "none";
            toEl.style.transition = "none";

            toEl.src = `images/${currentAlbum}/${images[nextIndex]}`;

            fromEl.style.transform = "translateX(0%)";
            toEl.style.transform = `translateX(${offsetIn}%)`;
            toEl.style.opacity = 1;

            void toEl.offsetWidth; // force reflow

            const easing = "cubic-bezier(0.22,0.61,0.36,1)";
            const duration = 500;

            fromEl.style.transition = `transform ${duration}ms ${easing}, opacity ${duration}ms`;
            toEl.style.transition = `transform ${duration}ms ${easing}, opacity ${duration}ms`;

            fromEl.style.transform = `translateX(${offsetOut}%)`;
            fromEl.style.opacity = 0.2;

            toEl.style.transform = "translateX(0%)";
            toEl.style.opacity = 1;

            fromEl.addEventListener("transitionend", function done() {
                fromEl.removeEventListener("transitionend", done);

                fromEl.style.transition = "none";
                fromEl.style.opacity = 0;
                fromEl.style.transform = `translateX(${offsetIn}%)`;

                currentIndex = nextIndex;
                caption.textContent = images[currentIndex];
                scrollThumbIntoView(currentIndex);
                updateCounter();

                // ƒê·∫£o role 2 img
                currentEl = toEl;
                bufferEl = fromEl;

                isAnimating = false;

                // Sau khi chuy·ªÉn xong 1 ·∫£nh, check xem c√≥ c·∫ßn load th√™m batch kh√¥ng
                maybeLoadMore();
            });
        }

        // N√∫t ƒëi·ªÅu h∆∞·ªõng
        document.querySelector(".nav-prev").onclick = () => {
            goTo(currentIndex - 1, "left");
        };
        document.querySelector(".nav-next").onclick = () => {
            goTo(currentIndex + 1, "right");
        };

        // ---------------------------
        // Vu·ªët ƒë·ªÉ chuy·ªÉn ·∫£nh
        // ---------------------------
        // let touchStartX = 0;
        // let touchEndX = 0;
        // const swipeZone = document.querySelector(".slideshow");

        // swipeZone.addEventListener("touchstart", (e) => {
        //     touchStartX = e.changedTouches[0].screenX;
        // });

        // swipeZone.addEventListener("touchend", (e) => {
        //     touchEndX = e.changedTouches[0].screenX;
        //     handleSwipe();
        // });

        // function handleSwipe() {
        //     const swipeDistance = touchEndX - touchStartX;
        //     if (Math.abs(swipeDistance) < 50) return; // b·ªè vu·ªët nh·∫π

        //     if (swipeDistance > 0) {
        //         // vu·ªët sang ph·∫£i -> ·∫£nh tr∆∞·ªõc
        //         goTo(currentIndex - 1, "left");
        //     } else {
        //         // vu·ªët sang tr√°i -> ·∫£nh sau
        //         goTo(currentIndex + 1, "right");
        //     }
        // }

        // ---------------------------
        // Auto loadmore khi scroll thumbnail t·ªõi cu·ªëi
        // ---------------------------
        // Horizontal scrolling b·∫±ng con lƒÉn chu·ªôt
        thumbs.addEventListener('wheel', (e) => {
            // N·∫øu cu·ªôn d·ªçc nhi·ªÅu h∆°n ngang th√¨ chuy·ªÉn n√≥ th√†nh scrollLeft
            if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
                e.preventDefault(); // ch·∫∑n scroll d·ªçc m·∫∑c ƒë·ªãnh
                thumbs.scrollLeft += e.deltaY; // d√πng deltaY ƒë·ªÉ cu·ªôn ngang
            }
        }, { passive: false });

        thumbs.addEventListener("scroll", () => {
            const nearEnd = thumbs.scrollWidth - thumbs.clientWidth - 50;
            console.log('nearEnd', nearEnd, 'scrollLeft', thumbs.scrollLeft);
            if (thumbs.scrollLeft >= nearEnd) {
                maybeLoadMore();
            }
        });


        // ---------------------------
        // B·∫Øt ƒë·∫ßu: load CSV khi trang s·∫µn s√†ng
        // ---------------------------
        document.addEventListener("DOMContentLoaded", () => {
            loadCsv();
        });
    </script>

</body>

</html>